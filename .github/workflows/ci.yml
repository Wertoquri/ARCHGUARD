name: CI

on:
  push:
    branches: [ main ]
    tags: ['*']
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,md,css}"

  migration-tests:
    name: Migration Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Run migration dry-run/rollback tests
        run: npx vitest run test/dryrun_rollback.test.js --run

  policy-framework-tests:
    name: Policy Framework Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run policy fixture tests
        run: npm run test:policy

  evaluate-pr:
    name: Evaluate PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run ARCHGUARD analysis for PR
        run: |
          mkdir -p tmp
          node src/cli.js --policy examples/policy.yaml --out tmp/findings_pr.raw.json --fail-on critical

      - name: Apply baseline and enforce fail threshold
        run: |
          node scripts/apply_baseline.js \
            --in tmp/findings_pr.raw.json \
            --out tmp/findings_pr.json \
            --baseline config/archguard-baseline.json \
            --summary tmp/findings_pr_summary.json \
            --fail-on high

      - name: Apply ownership mapping
        run: |
          node scripts/apply_ownership.js \
            --in tmp/findings_pr.json \
            --out tmp/findings_pr.json \
            --owners config/ownership-map.json \
            --summary tmp/findings_pr_ownership_summary.json

      - name: Collect changed files for PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const names = files.map(f => f.filename);
            fs.mkdirSync('tmp', { recursive: true });
            fs.writeFileSync('tmp/changed_files.json', JSON.stringify(names, null, 2));

      - name: Emit inline annotations for changed files
        run: |
          node scripts/emit_pr_annotations.js \
            --findings tmp/findings_pr.json \
            --changed tmp/changed_files.json \
            --max 40

      - name: Build dependency usage map
        run: node scripts/build_dependency_usage.js --out tmp/dependency_usage.json

      - name: Run npm audit and correlate dependency risk
        run: |
          npm audit --json > tmp/npm_audit.json || echo "{}" > tmp/npm_audit.json
          node scripts/correlate_sbom_risk.js \
            --sbom tmp/npm_audit.json \
            --usage tmp/dependency_usage.json \
            --out tmp/sbom_risk_pr.json

      - name: Upload findings artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-findings
          path: |
            tmp/findings_pr.json
            tmp/findings_pr_summary.json
            tmp/findings_pr_ownership_summary.json
            tmp/sbom_risk_pr.json

      - name: Post findings summary as PR comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const findingsPath = 'tmp/findings_pr.json';
            const sbomPath = 'tmp/sbom_risk_pr.json';
            if (!fs.existsSync(findingsPath)) {
              core.info('No findings file to post.');
              return;
            }
            const txt = fs.readFileSync(findingsPath, 'utf8');
            let findings = null;
            try { findings = JSON.parse(txt); } catch (e) { findings = null; }

            let sbomRisk = null;
            if (fs.existsSync(sbomPath)) {
              try { sbomRisk = JSON.parse(fs.readFileSync(sbomPath, 'utf8')); } catch (e) { sbomRisk = null; }
            }

            const violations = (findings && findings.violations) ? findings.violations : [];
            let body = `**ARCHGUARD analysis** — ${violations.length} violation(s) found for this PR.\n\n`;
            if (violations.length > 0) {
              body += `**Top ${Math.min(10, violations.length)} violations:**\n`;
              for (let i = 0; i < Math.min(10, violations.length); i++) {
                const v = violations[i];
                const rule = v.rule || v.type || v.ruleId || 'rule';
                const msg = v.message || v.summary || JSON.stringify(v);
                body += `- ${rule}: ${msg}\n`;
              }
              body += '\n';
            }

            const riskEntries = Array.isArray(sbomRisk?.entries) ? sbomRisk.entries : [];
            if (riskEntries.length > 0) {
              body += `**Top ${Math.min(5, riskEntries.length)} dependency risk items (SBOM correlation):**\n`;
              for (let i = 0; i < Math.min(5, riskEntries.length); i++) {
                const row = riskEntries[i] || {};
                const pkg = row.package || 'unknown-package';
                const score = Number(row.riskScore || 0);
                const vulnCount = Array.isArray(row.vulnerabilities) ? row.vulnerabilities.length : 0;
                const exposure = Number(row.exposure || 0);
                body += `- ${pkg}: riskScore=${score}, vulnerabilities=${vulnCount}, usedBy=${exposure}\n`;
              }
              body += '\n';
            }

            body += `Download full findings artifact from the workflow run artifacts.`;
            const prNumber = context.payload.pull_request && context.payload.pull_request.number;
            if (!prNumber) {
              core.info('No pull_request number in context; skipping comment');
              return;
            }
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });

      - name: Notify webhook on high/critical findings (optional)
        if: always()
        env:
          ARCHGUARD_WEBHOOK_URL: ${{ vars.ARCHGUARD_WEBHOOK_URL }}
        run: |
          if [ -z "$ARCHGUARD_WEBHOOK_URL" ]; then
            echo "ARCHGUARD_WEBHOOK_URL is not configured; skipping webhook notification."
            exit 0
          fi
          if [ ! -f tmp/findings_pr_summary.json ]; then
            echo "No summary file found; skipping webhook notification."
            exit 0
          fi
          HIGH_COUNT=$(node -e "const fs=require('fs'); const s=JSON.parse(fs.readFileSync('tmp/findings_pr_summary.json','utf8')); process.stdout.write(String((s.remainingBySeverity?.high||0)+(s.remainingBySeverity?.critical||0)));")
          if [ "$HIGH_COUNT" = "0" ]; then
            echo "No high/critical findings after baseline; skipping webhook notification."
            exit 0
          fi
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PAYLOAD=$(node -e "const high=process.argv[1]; const runUrl=process.argv[2]; const repo=process.argv[3]; const pr=process.argv[4]; const msg={text:`ARCHGUARD alert: ${high} high/critical finding(s) in ${repo} PR #${pr}. Run: ${runUrl}`}; process.stdout.write(JSON.stringify(msg));" "$HIGH_COUNT" "$RUN_URL" "${{ github.repository }}" "${{ github.event.pull_request.number }}")
          curl -sS -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$ARCHGUARD_WEBHOOK_URL"

  test-and-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - migration-tests
      - policy-framework-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run tests
        run: npm test --silent

      - name: Run coverage (optional)
        run: npm run coverage --silent || echo "No coverage generated"

      - name: "Debug: show coverage lcov"
        run: |
          echo "Node:", $(node -v) || true
          echo "NPM:", $(npm -v) || true
          echo "c8 version:"; npx c8 --version || true
          echo "Coverage lcov path: coverage/lcov.info"
          if [ -f coverage/lcov.info ]; then
            echo '--- size (bytes) ---'
            wc -c coverage/lcov.info || true
            echo '--- head (first 200 lines) ---'
            head -n 200 coverage/lcov.info || true
            echo '--- tail (last 50 lines) ---'
            tail -n 50 coverage/lcov.info || true
            echo '--- non-zero DA entries (sample 20) ---'
            grep -E 'DA:[0-9]+,[1-9]' coverage/lcov.info | head -n 20 || true
            echo '--- non-zero DA count ---'
            grep -E 'DA:[0-9]+,[1-9]' coverage/lcov.info | wc -l || true
          else
            echo 'coverage/lcov.info not found'
          fi
          echo '--- coverage directory listing (recursive) ---'
          ls -la coverage || true
          find coverage -type f -maxdepth 3 -exec ls -l {} \; || true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage
            coverage/**

      - name: Run ARCHGUARD analysis
        run: |
          node src/cli.js --policy examples/policy.yaml --out findings_raw.json --fail-on critical
          node scripts/apply_baseline.js \
            --in findings_raw.json \
            --out findings.json \
            --baseline config/archguard-baseline.json \
            --summary findings_summary.json \
            --fail-on high
          node scripts/apply_ownership.js \
            --in findings.json \
            --out findings.json \
            --owners config/ownership-map.json \
            --summary findings_ownership_summary.json

      - name: Build dependency usage map
        run: node scripts/build_dependency_usage.js --out tmp/dependency_usage.json

      - name: Run npm audit and correlate dependency risk
        run: |
          npm audit --json > tmp/npm_audit.json || echo "{}" > tmp/npm_audit.json
          node scripts/correlate_sbom_risk.js \
            --sbom tmp/npm_audit.json \
            --usage tmp/dependency_usage.json \
            --out tmp/sbom_risk.json

      - name: Generate dependency graph and PNG
        run: npm run depgraph:all --silent

      - name: Upload dep graph artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dep-graph
          path: |
            docs/dep_graph.json
            docs/dep_graph.png

      - name: Upload findings summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: archguard-findings-summary
          path: |
            findings.json
            findings_summary.json
            findings_ownership_summary.json
            tmp/sbom_risk.json

      - name: Capture trend snapshot
        run: |
          node scripts/snapshot_trends.js \
            --in findings.json \
            --out tmp/trend_snapshot.json \
            --history analytics/trends_history.json \
            --max 200

      - name: Upload trend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: archguard-trends
          path: |
            tmp/trend_snapshot.json
            analytics/trends_history.json

  nightly-archguard:
    name: Nightly ARCHGUARD scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run nightly ARCHGUARD analysis with baseline
        run: |
          mkdir -p tmp
          node src/cli.js --policy examples/policy.yaml --out tmp/nightly_findings_raw.json --fail-on critical
          node scripts/apply_baseline.js \
            --in tmp/nightly_findings_raw.json \
            --out tmp/nightly_findings.json \
            --baseline config/archguard-baseline.json \
            --summary tmp/nightly_summary.json \
            --fail-on high
          node scripts/apply_ownership.js \
            --in tmp/nightly_findings.json \
            --out tmp/nightly_findings.json \
            --owners config/ownership-map.json \
            --summary tmp/nightly_ownership_summary.json

      - name: Build nightly dependency usage map
        run: node scripts/build_dependency_usage.js --out tmp/dependency_usage_nightly.json

      - name: Run nightly npm audit and correlate risk
        run: |
          npm audit --json > tmp/npm_audit_nightly.json || echo "{}" > tmp/npm_audit_nightly.json
          node scripts/correlate_sbom_risk.js \
            --sbom tmp/npm_audit_nightly.json \
            --usage tmp/dependency_usage_nightly.json \
            --out tmp/sbom_risk_nightly.json

      - name: Upload nightly findings artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-archguard-findings
          path: |
            tmp/nightly_findings.json
            tmp/nightly_summary.json
            tmp/nightly_ownership_summary.json
            tmp/sbom_risk_nightly.json

      - name: Capture nightly trend snapshot
        run: |
          node scripts/snapshot_trends.js \
            --in tmp/nightly_findings.json \
            --out tmp/nightly_trend_snapshot.json \
            --history analytics/trends_history.json \
            --max 200

      - name: Upload nightly trend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-archguard-trends
          path: |
            tmp/nightly_trend_snapshot.json
            analytics/trends_history.json

      - name: Zip dep graph artifacts
        run: |
          sudo apt-get update -y && sudo apt-get install -y zip || true
          zip -j docs/dep_graph_artifacts.zip docs/dep_graph.json docs/dep_graph.png

      - name: Zip coverage artifacts
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          sudo apt-get update -y && sudo apt-get install -y zip || true
          if [ -d coverage ]; then
            zip -r docs/coverage_artifacts.zip coverage || true
          else
            echo "No coverage directory found, skipping coverage ZIP"
          fi

      - name: Create draft GitHub release and upload dep-graph ZIP
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: |
            Dependency graph artifacts (JSON + PNG) generated by ARCHGUARD for commit `${{ github.sha }}`.
            Files: docs/dep_graph.json, docs/dep_graph.png
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dep-graph ZIP to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: docs/dep_graph_artifacts.zip
          asset_name: dep_graph_artifacts_${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload coverage ZIP to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: docs/coverage_artifacts.zip
          asset_name: coverage_report_${{ github.ref_name }}.zip
          asset_content_type: application/zip

  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci || npm install --no-audit --no-fund

      - name: Run coverage
        run: npm run coverage --silent || echo "No coverage generated"

      - name: Check for coverage directory
        id: check_cov
        run: |
          if [ -d coverage ]; then
            echo "coverage=true" >> $GITHUB_OUTPUT
          else
            echo "coverage=false" >> $GITHUB_OUTPUT
          fi

      - name: Zip coverage artifacts
        if: steps.check_cov.outputs.coverage == 'true'
        run: |
          sudo apt-get update -y && sudo apt-get install -y zip || true
          zip -r docs/coverage_artifacts.zip coverage || true

      - name: Create draft GitHub release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: |
            Automated release for tag `${{ github.ref_name }}` — coverage artifacts (if any) attached.
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload coverage ZIP to release
        if: steps.check_cov.outputs.coverage == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: docs/coverage_artifacts.zip
          asset_name: coverage_report_${{ github.ref_name }}.zip
          asset_content_type: application/zip
