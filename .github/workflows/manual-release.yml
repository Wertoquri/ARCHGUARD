name: Manual Dep-Graph Release

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Commit SHA or branch to build artifacts from (optional)'
        required: false
        default: ''
      tag:
        description: 'Tag name to create (if empty, an auto tag dep-graph-YYYYMMDD-HHMM will be used)'
        required: false
        default: ''

jobs:
  manual-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Resolve ref
        id: resolve
        run: |
          if [ -n "${{ github.event.inputs.ref }}" ]; then
            REF="${{ github.event.inputs.ref }}"
          else
            REF="${{ github.sha }}"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT

      - name: Fetch and checkout ref
        run: |
          git fetch --no-tags origin "${{ steps.resolve.outputs.ref }}" || true
          git checkout --detach "${{ steps.resolve.outputs.ref }}"

      - name: Compute tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="dep-graph-$(date +%Y%m%d-%H%M)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create git tag and push
        run: |
          git tag -f "${{ steps.tag.outputs.tag }}" "${{ steps.resolve.outputs.ref }}"
          git push origin --force --tags

      - name: Install dependencies
        run: npm ci

      - name: Generate dependency graph and PNG
        run: npm run depgraph:all --silent

      - name: Zip dep graph artifacts
        run: |
          sudo apt-get update -y && sudo apt-get install -y zip || true
          zip -j docs/dep_graph_artifacts.zip docs/dep_graph.json docs/dep_graph.png

      - name: Create draft release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: ${{ steps.tag.outputs.tag }}
          body: |
            Dependency graph artifacts (JSON + PNG) generated by ARCHGUARD for commit `${{ github.sha }}`.
            Files: docs/dep_graph.json, docs/dep_graph.png
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dep-graph ZIP to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: docs/dep_graph_artifacts.zip
          asset_name: dep_graph_artifacts_${{ steps.tag.outputs.tag }}.zip
          asset_content_type: application/zip
